const chai = require("chai");
const chaiAsPromised = require("chai-as-promised");
const { artifacts } = require("hardhat");

const ERC20 = artifacts.require("@openzeppelin/contracts/token/ERC20/IERC20.sol:IERC20");

const AloeBlend = artifacts.require("AloeBlend");
const Factory = artifacts.require("Factory");
const VolatilityOracle = artifacts.require("VolatilityOracle");

const CompoundCEtherSilo = artifacts.require("CompoundCEtherSilo");
const CompoundCTokenSilo = artifacts.require("CompoundCTokenSilo");

chai.use(chaiAsPromised);
const expect = chai.expect;

web3.eth.extend({
  property: "hardhat",
  methods: [
    {
      name: "increaseTime",
      call: "evm_increaseTime",
      params: 1,
    },
    {
      name: "mine",
      call: "evm_mine",
      params: 0,
    },
    {
      name: "impersonate",
      call: "hardhat_impersonateAccount",
      params: 1,
    },
    {
      name: "stopImpersonating",
      call: "hardhat_stopImpersonatingAccount",
      params: 1,
    },
    {
      name: "reset",
      call: "hardhat_reset",
      params: 1,
      /*
      {
        forking: {
          jsonRpcUrl: "https://eth-mainnet.alchemyapi.io/v2/<key>",
          blockNumber: 11095000,
        },
      }
      */
    },
  ],
});

const BYTECODE =
  "0x6102006040523480156200001257600080fd5b5060405162005e4538038062005e4583398101604081905262000035916200067a565b82836001600160a01b0316630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000075573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200009b9190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620000d9573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526200010391908101906200073e565b846001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000142573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620001689190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620001a6573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052620001d091908101906200073e565b604051602001620001e3929190620007f6565b604051602081830303815290604052806040518060400160405280600a815260200169105313d14b509311539160b21b8152506012826000908051906020019062000230929190620005bb565b50815162000246906001906020850190620005bb565b5060ff81166080524660a0526200025c620004ba565b60c052505050506001600160a01b03811660e081905260408051630dfe168160e01b81529051630dfe1681916004808201926020929091908290030181865afa158015620002ae573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620002d49190620006ce565b6001600160a01b0316610100816001600160a01b031681525050806001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156200032d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003539190620006ce565b6001600160a01b0316610120816001600160a01b031681525050806001600160a01b031663d0c93a7c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015620003ac573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003d291906200084d565b60020b6101408160020b8152505050620003ff620d89e719610140516200055660201b620020d71760201c565b60020b610160526200042e62000419620d89e71962000872565b610140516200058b60201b620021061760201c565b60020b61018052604080516355b13a4f60e01b8152905133916355b13a4f9160048083019260209291908290030181865afa15801562000472573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620004989190620006ce565b6001600160a01b039081166101a0529182166101c052166101e05250620009b6565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6000604051620004ee9190620008e1565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b60008062000565838562000985565b905060008160020b1315620005805783038201905062000585565b830390505b92915050565b6000806200059a838562000985565b905060008160020b12620005b2578303905062000585565b90920303919050565b828054620005c990620008a4565b90600052602060002090601f016020900481019282620005ed576000855562000638565b82601f106200060857805160ff191683800117855562000638565b8280016001018555821562000638579182015b82811115620006385782518255916020019190600101906200061b565b50620006469291506200064a565b5090565b5b808211156200064657600081556001016200064b565b6001600160a01b03811681146200067757600080fd5b50565b6000806000606084860312156200069057600080fd5b83516200069d8162000661565b6020850151909350620006b08162000661565b6040850151909250620006c38162000661565b809150509250925092565b600060208284031215620006e157600080fd5b8151620006ee8162000661565b9392505050565b634e487b7160e01b600052604160045260246000fd5b60005b83811015620007285781810151838201526020016200070e565b8381111562000738576000848401525b50505050565b6000602082840312156200075157600080fd5b81516001600160401b03808211156200076957600080fd5b818401915084601f8301126200077e57600080fd5b815181811115620007935762000793620006f5565b604051601f8201601f19908116603f01168101908382118183101715620007be57620007be620006f5565b81604052828152876020848701011115620007d857600080fd5b620007eb8360208301602088016200070b565b979650505050505050565b6a020b637b290213632b732160ad1b8152600083516200081e81600b8501602088016200070b565b602f60f81b600b9184019182015283516200084181600c8401602088016200070b565b01600c01949350505050565b6000602082840312156200086057600080fd5b81518060020b8114620006ee57600080fd5b60008160020b627fffff198114156200089b57634e487b7160e01b600052601160045260246000fd5b60000392915050565b600181811c90821680620008b957607f821691505b60208210811415620008db57634e487b7160e01b600052602260045260246000fd5b50919050565b600080835481600182811c915080831680620008fe57607f831692505b60208084108214156200091f57634e487b7160e01b86526022600452602486fd5b818015620009365760018114620009485762000977565b60ff1986168952848901965062000977565b60008a81526020902060005b868110156200096f5781548b82015290850190830162000954565b505084890196505b509498975050505050505050565b60008260020b80620009a757634e487b7160e01b600052601260045260246000fd5b808360020b0791505092915050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e0516152b462000b916000396000818161092801528181610b96015281816113220152818161177d0152818161193a01528181611a090152818161259b0152818161297f01528181612a280152818161303201526133fa01526000818161058601528181610b64015281816112f001528181611753015281816117e0015281816118c0015281816124a801528181612bbc01528181612c6501528181612fce01526133690152600081816104f40152612d73015260008181612f3f0152612f71015260008181612eea0152612f15015260008181610c5301528181610c9801528181610cdf01528181610db101528181610df601528181610e3d01528181612e7c0152612eb50152600081816105520152818161152701528181611c9f01528181611e4a015281816128eb01526132370152600081816104a8015281816114f201528181611c6b01528181611e1001528181612b6f01526131770152600081816106ab01528181610a99015281816113530152818161163001528181611dd301528181612220015281816122720152612d47015260006115f5015260006115c00152600061044a01526152b46000f3fe6080604052600436106102bf5760003560e01c8063819b71c81161016e578063c3bd5945116100cb578063d5ffb4e51161007f578063da3848db11610064578063da3848db1461080e578063dd62ed3e146108de578063e035814d1461091657600080fd5b8063d5ffb4e5146107cd578063d785598e146107f857600080fd5b8063d0c9bdb4116100b0578063d0c9bdb414610763578063d34879971461078d578063d505accf146107ad57600080fd5b8063c3bd594514610737578063c620033f1461074d57600080fd5b80639f13f76d11610122578063a9059cbb11610107578063a9059cbb14610702578063a932492f14610722578063ad1383f81461032657600080fd5b80639f13f76d146106cd578063a41fe49f146106e257600080fd5b806388a9f8bb1161015357806388a9f8bb1461066e57806395d89b41146106845780639b1475581461069957600080fd5b8063819b71c81461062f57806383db382d1461064557600080fd5b806332e7c5bf1161021c5780635ee04d78116101d057806370a08231116101b557806370a08231146105a85780637ecebe00146105d55780637f86d13c1461060257600080fd5b80635ee04d781461054057806362d7d45e1461057457600080fd5b8063443ec74d11610201578063443ec74d1461049657806355b13a4f146104e25780635d7f850c1461051657600080fd5b806332e7c5bf1461046c5780633644e5151461048157600080fd5b806321c28191116102735780632505c3d9116102585780632505c3d9146103c957806330adf81f14610404578063313ce5671461043857600080fd5b806321c281911461038757806323b872dd146103a957600080fd5b80630f529ba2116102a45780630f529ba2146103265780631304fd581461034d57806318160ddd1461037157600080fd5b806306fdde03146102cb578063095ea7b3146102f657600080fd5b366102c657005b600080fd5b3480156102d757600080fd5b506102e061094a565b6040516102ed9190614a48565b60405180910390f35b34801561030257600080fd5b50610316610311366004614a93565b6109d8565b60405190151581526020016102ed565b34801561033257600080fd5b5061033b600a81565b60405160ff90911681526020016102ed565b34801561035957600080fd5b5061036360095481565b6040519081526020016102ed565b34801561037d57600080fd5b5061036360025481565b34801561039357600080fd5b506103a76103a2366004614abf565b610a45565b005b3480156103b557600080fd5b506103166103c4366004614adc565b61115d565b3480156103d557600080fd5b506103e96103e4366004614b1d565b611251565b604080519384526020840192909252908201526060016102ed565b34801561041057600080fd5b506103637f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c981565b34801561044457600080fd5b5061033b7f000000000000000000000000000000000000000000000000000000000000000081565b34801561047857600080fd5b5061033b600281565b34801561048d57600080fd5b506103636115bc565b3480156104a257600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020016102ed565b3480156104ee57600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b34801561052257600080fd5b5061052b611617565b604080519283526020830191909152016102ed565b34801561054c57600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b34801561058057600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b3480156105b457600080fd5b506103636105c3366004614abf565b60036020526000908152604090205481565b3480156105e157600080fd5b506103636105f0366004614abf565b60056020526000908152604090205481565b34801561060e57600080fd5b5061036361061d366004614abf565b600b6020526000908152604090205481565b34801561063b57600080fd5b5061036360085481565b34801561065157600080fd5b5061065b61019281565b60405160029190910b81526020016102ed565b34801561067a57600080fd5b506103636101f481565b34801561069057600080fd5b506102e06116d2565b3480156106a557600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b3480156106d957600080fd5b5061033b600481565b3480156106ee57600080fd5b5061052b6106fd366004614b4f565b6116df565b34801561070e57600080fd5b5061031661071d366004614a93565b611d32565b34801561072e57600080fd5b5061033b601481565b34801561074357600080fd5b50610363600a5481565b34801561075957600080fd5b5061065b616c5081565b34801561076f57600080fd5b50610778611daa565b60405163ffffffff90911681526020016102ed565b34801561079957600080fd5b506103a76107a8366004614b7b565b611dc8565b3480156107b957600080fd5b506103a76107c8366004614c0a565b611e77565b3480156107d957600080fd5b506107e46201518081565b60405162ffffff90911681526020016102ed565b34801561080457600080fd5b5061036360075481565b34801561081a57600080fd5b5060065461088590600281810b9163010000008104820b9166010000000000008204810b916901000000000000000000810490910b9065ffffffffffff600160601b8204169063ffffffff600160901b8204169060ff600160b01b8204811691600160b81b90041688565b604080516002998a0b815297890b602089015295880b958701959095529290950b606085015265ffffffffffff16608084015263ffffffff90931660a083015291151560c082015290151560e0820152610100016102ed565b3480156108ea57600080fd5b506103636108f9366004614c7b565b600460209081526000928352604080842090915290825290205481565b34801561092257600080fd5b506104ca7f000000000000000000000000000000000000000000000000000000000000000081565b6000805461095790614cb4565b80601f016020809104026020016040519081016040528092919081815260200182805461098390614cb4565b80156109d05780601f106109a5576101008083540402835291602001916109d0565b820191906000526020600020905b8154815290600101906020018083116109b357829003601f168201915b505050505081565b3360008181526004602090815260408083206001600160a01b038716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92590610a339086815260200190565b60405180910390a35060015b92915050565b60005a90506000806000806000610a5a612132565b6006805460ff60b81b1916600160b81b1790556040805160608101825260008082526020820181905291810191909152949950929750909550935091507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa158015610af5573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b199190614d11565b5050505060029190910b6040840152506001600160a01b0316808252610b449080600160601b6122d8565b6001600160e01b031660208201526000610b5d85612385565b9050610b917f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166123a9565b610bc37f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166123a9565b6000806000610bd98a8a876000015160006123ea565b92509250925080606001516001600160801b0316600014610c09576060810151610c04908a9061275b565b505050505b6000610c3d61271085610c2e86600160601b8b602001516001600160e01b03166122d8565b610c389088614dbb565b6122d8565b9050611324811015610d9d57610c7786604001517f0000000000000000000000000000000000000000000000000000000000000000612106565b60020b60408b015260608201516001600160801b031615801590610cd357507f00000000000000000000000000000000000000000000000000000000000000008a60400151610cc69190614dd3565b60020b8a6020015160020b145b15610cdd57600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60400151610d0d9190614dd3565b60020b6020808c0191909152860151600090600190610d3b9087906001600160e01b0316600160601b6122d8565b610d459086614e1b565b901c90508260200151811115610d5c575060208201515b6000610d666128c7565b905081811015610d8057610d7b818303612961565b810191505b50610d95610d8e8c83612a63565b8c90612a88565b505050610f1c565b6113ec811115610ee557610dd586604001517f00000000000000000000000000000000000000000000000000000000000000006120d7565b60020b60208b015260608201516001600160801b031615801590610e3157507f00000000000000000000000000000000000000000000000000000000000000008a60200151610e249190614e32565b60020b8a6040015160020b145b15610e3b57600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60200151610e6b9190614e32565b60020b60408b01526020860151600090600190610e98908690600160601b906001600160e01b03166122d8565b610ea29087614e1b565b8451911c9150811115610eb3575081515b6000610ebd612b4b565b905081811015610ed757610ed2818303612b9e565b810191505b50610d95610d8e8c83612ca0565b60408051606081018252600080825260208201819052918101919091529950610f16868c846040015187878c612cc5565b9a504298505b5a610f298d615208614e79565b63ffffffff16610f399190614e1b565b9b508763ffffffff168c63ffffffff161115610f53578b97505b610f608d868e8b8b6130d9565b6002546040805184815260208101929092528101869052606081018590529097507f802a0d65ee1ffb3e6af96deafe1fc3e6402b2672a2f4b79d1b23c4a06c998f349060800160405180910390a16040518061010001604052808c6020015160020b81526020018c6040015160020b81526020018b6020015160020b81526020018b6040015160020b81526020018a65ffffffffffff1681526020018963ffffffff168152602001881515815260200160001515815250600660008201518160000160006101000a81548162ffffff021916908360020b62ffffff16021790555060208201518160000160036101000a81548162ffffff021916908360020b62ffffff16021790555060408201518160000160066101000a81548162ffffff021916908360020b62ffffff16021790555060608201518160000160096101000a81548162ffffff021916908360020b62ffffff160217905550608082015181600001600c6101000a81548165ffffffffffff021916908365ffffffffffff16021790555060a08201518160000160126101000a81548163ffffffff021916908363ffffffff16021790555060c08201518160000160166101000a81548160ff02191690831515021790555060e08201518160000160176101000a81548160ff02191690831515021790555090505050505050505050505050505050565b6001600160a01b038316600090815260046020908152604080832033845290915281205460001981146111b9576111948382614e1b565b6001600160a01b03861660009081526004602090815260408083203384529091529020555b6001600160a01b038516600090815260036020526040812080548592906111e1908490614e1b565b90915550506001600160a01b03808516600081815260036020526040908190208054870190555190918716907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9061123c9087815260200190565b60405180910390a360019150505b9392505050565b600080808615158061126257508515155b6112b35760405162461bcd60e51b815260206004820152600f60248201527f416c6f653a2030206465706f736974000000000000000000000000000000000060448201526064015b60405180910390fd5b6000806112be612132565b50506006805460ff60b81b1916600160b81b1790555090925090506112e2826134fd565b6112eb816134fd565b61131d7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166123a9565b61134f7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166123a9565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa1580156113af573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113d39190614d11565b50505050505090506000806113eb85858560016123ea565b509150915061140060025483838f8f886135c0565b91995097509550876114455760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b60448201526064016112aa565b898710156114955760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f77000000000000000000000060448201526064016112aa565b888610156114e55760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f77000000000000000000000060448201526064016112aa565b61151a6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633308a613706565b61154f6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016333089613706565b6115593389613789565b604080518981526020810189905290810187905233907f36af321ec8d3c75236829c5317affd40ddb308863a1236d2d277a4025cccee1e9060600160405180910390a250506006805460ff60b81b19169055509398929750909550909350505050565b60007f000000000000000000000000000000000000000000000000000000000000000046146115f2576115ed6137f5565b905090565b507f000000000000000000000000000000000000000000000000000000000000000090565b600080600080611625612132565b5050509150915060007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa15801561168c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116b09190614d11565b50505050505090506116c583838360006123ea565b5090969095509350505050565b6001805461095790614cb4565b600080846117205760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b60448201526064016112aa565b60008061172b612132565b50506006805460ff60b81b1916600160b81b1790555090925090506117786001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000166123a9565b6117aa7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166123a9565b60025460008080806117ba612b4b565b6007546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa158015611827573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061184b9190614ea1565b925083831161185b576000611871565b600a6118678585614e1b565b6118719190614ed0565b9350611892846118818585614dbb565b61188b9190614e1b565b8d876122d8565b98508189111561190c57816118a78a86614dbb565b6118b19190614e1b565b91506118e66001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168361388f565b83600960008282546118f89190614dbb565b9091555061190890508284614e1b565b6007555b6119146128c7565b6008546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa158015611981573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119a59190614ea1565b92508383116119b55760006119cb565b600a6119c18585614e1b565b6119cb9190614ed0565b93506119db846118818585614dbb565b975081881115611a5557816119f08986614dbb565b6119fa9190614e1b565b9150611a2f6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168361388f565b83600a6000828254611a419190614dbb565b90915550611a5190508284614e1b565b6008555b6000611a6088613909565b505050509050611a84611a7d826001600160801b03168f896122d8565b899061275b565b92975090955093509150611a98858b614dbb565b9950611aa4848a614dbb565b9850611ab1600a84614ed0565b9450611abe600a83614ed0565b9350611ad4611acd8685614e1b565b8e886122d8565b611ade908b614dbb565b9950611aed611acd8584614e1b565b611af7908a614dbb565b98508460096000828254611b0b9190614dbb565b9250508190555083600a6000828254611b249190614dbb565b9250508190555050856040015160020b866020015160020b14611bbe576000611b4c87613909565b505050509050611b70611b69826001600160801b03168f896122d8565b889061275b565b92975090955093509150611b85838e886122d8565b611b8f9086614dbb565b611b99908b614dbb565b9950611ba6828e886122d8565b611bb09085614dbb565b611bba908a614dbb565b9850505b8a891015611c0e5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f77000000000000000000000060448201526064016112aa565b89881015611c5e5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f77000000000000000000000060448201526064016112aa565b611c926001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338b6139f1565b611cc66001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338a6139f1565b611cd0338d613a21565b604080518d8152602081018b905290810189905233907f02f25270a4d87bea75db541cdfe559334a275b4a233520ed6c0a2429667cca949060600160405180910390a250506006805460ff60b81b191690555094989397509295505050505050565b33600090815260036020526040812080548391908390611d53908490614e1b565b90915550506001600160a01b038316600081815260036020526040908190208054850190555133907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90610a339086815260200190565b6006546000906115ed90600160601b900465ffffffffffff16612385565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001614611dfd57600080fd5b8315611e3757611e376001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633866139f1565b8215611e7157611e716001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633856139f1565b50505050565b42841015611ec75760405162461bcd60e51b815260206004820152601760248201527f5045524d49545f444541444c494e455f4558504952454400000000000000000060448201526064016112aa565b6000611ed16115bc565b6001600160a01b0389811660008181526005602090815260409182902080546001810190915582517f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c98184015280840194909452938c166060840152608083018b905260a083019390935260c08083018a90528151808403909101815260e08301909152805192019190912061190160f01b6101008301526101028201929092526101228101919091526101420160408051601f198184030181528282528051602091820120600080855291840180845281905260ff88169284019290925260608301869052608083018590529092509060019060a0016020604051602081039080840390855afa158015611fea573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116158015906120205750886001600160a01b0316816001600160a01b0316145b61206c5760405162461bcd60e51b815260206004820152600e60248201527f494e56414c49445f5349474e455200000000000000000000000000000000000060448201526064016112aa565b6001600160a01b0390811660009081526004602090815260408083208b8516808552908352928190208a905551898152919350918a16917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a350505050505050565b6000806120e48385614ee4565b905060008160020b13156120fd57830382019050610a3f565b90920392915050565b6000806121138385614ee4565b905060008160020b126121295783039050610a3f565b90920303919050565b604080516060810182526000808252602082018190529181019190915260408051606081018252600080825260208201819052918101919091526040805161010081018252600654600281810b835263010000008204810b602084015266010000000000008204810b938301939093526901000000000000000000810490920b606082015265ffffffffffff600160601b830416608082015263ffffffff600160901b83041660a082015260ff600160b01b83048116151560c0830152600160b81b90920490911615801560e0830152600091829182919061221357600080fd5b60405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001826000015160020b8152602001826020015160020b81525060405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001836040015160020b8152602001836060015160020b81525082608001518360a001518460c0015195509550955095509550509091929394565b6000816122e457600080fd5b60008060001985870985870292508281108382030391505080600014156123105750829004905061124a565b83811061231c57600080fd5b60008486880960026001871981018816978890046003810283188082028403028082028403028082028403028082028403028082028403029081029092039091026000889003889004909101858311909403939093029303949094049190911702949350505050565b6000610a3f620186a06123a065ffffffffffff851642614e1b565b620151806122d8565b6040805160048152602481019091526020810180516001600160e01b0316630302f06b60e31b1790526123e6906001600160a01b03831690613a95565b5050565b60408051608081018252600080825260208201819052918101829052606081018290528190600080876040015160020b886020015160020b1461248d5761243088613909565b6001600160801b03948516606089018190529185169650909316935061245b928b92508a9150613aba565b602085015280845282908490612472908390614dbb565b905250602083018051829190612489908390614dbb565b9052505b6007546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156124f7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061251b9190614ea1565b905081811161252b576000612541565b600a6125378383614e1b565b6125419190614ed0565b91508561254e5781612551565b60005b8161255a612b4b565b6125649190614dbb565b61256e9190614e1b565b8351849061257d908390614dbb565b9052506008546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156125ea573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061260e9190614ea1565b905081811161261e576000612634565b600a61262a8383614e1b565b6126349190614ed0565b9150856126415781612644565b60005b8161264d6128c7565b6126579190614dbb565b6126619190614e1b565b836020018181516126729190614dbb565b905250604089015160208a0151600291820b910b146127425761269489613909565b6001600160801b0394851660408901819052918516965090931693506126bf928c92508a9150613aba565b9095509350856126d9576126d4600a83614ed0565b6126dc565b60005b83516126e9908490614dbb565b6126f39190614e1b565b6126fd9086614dbb565b9450856127145761270f600a82614ed0565b612717565b60005b8184602001516127279190614dbb565b6127319190614e1b565b61273b9085614dbb565b935061274f565b8251602084015190955093505b50509450945094915050565b60008080806001600160801b038516156128055785516020870151604080890151905163a34123a760e01b8152600292830b6004820152910b60248201526001600160801b03871660448201526001600160a01b039091169063a34123a79060640160408051808303816000875af11580156127db573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906127ff9190614f06565b90945092505b8551602087015160408089015190516309e3d67b60e31b8152306004820152600292830b6024820152910b60448201526001600160801b0360648201819052608482015260009182916001600160a01b0390911690634f1eb3d89060a40160408051808303816000875af1158015612881573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906128a59190614f41565b96999598506001600160801b039081168a900397509095168790039450505050565b600a546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a08231906024015b602060405180830381865afa158015612933573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906129579190614ea1565b6115ed9190614e1b565b6008546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156129ce573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906129f29190614ea1565b9050818111612a02576000612a09565b600a828203045b9150818103841115612a1b5781810393505b612a506001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683860161388f565b600a805483019055038290036008555090565b600061124a612a758460200151613aed565b612a828560400151613aed565b84613e40565b6000806001600160801b03831615612b4457835160208501516040808701519051633c8a7d8d60e01b8152306004820152600292830b6024820152910b60448201526001600160801b038516606482015260a06084820152600060a48201526001600160a01b0390911690633c8a7d8d9060c40160408051808303816000875af1158015612b1a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612b3e9190614f06565b90925090505b9250929050565b6009546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401612916565b6007546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015612c0b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612c2f9190614ea1565b9050818111612c3f576000612c46565b600a828203045b9150818103841115612c585781810393505b612c8d6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683860161388f565b6009805483019055038290036007555090565b600061124a612cb28460200151613aed565b612cbf8560400151613aed565b84613e91565b604080516060810182526000808252602082018190529181018290529080612ced888861275b565b935093505050600a60ff168281612d0657612d06614eba565b60098054929091049091019055600a805491819004909101905550600082612d3057616c50612de7565b60405163b168197d60e01b81526001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081166004830152612de7917f00000000000000000000000000000000000000000000000000000000000000009091169063b168197d906024016020604051808303816000875af1158015612dbe573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612de29190614ea1565b613ee8565b60020b60011d9050600080612dfd878785613f62565b91509150600080612e13896101f46127106122d8565b612e1b612b4b565b039150612e2d886101f46127106122d8565b612e356128c7565b03905083821215612e545760009850612e4f828503612b9e565b820193505b82811215612e705760009750612e6b818403612961565b810192505b612ea0858d60400151037f0000000000000000000000000000000000000000000000000000000000000000612106565b60020b60208c015260408c0151612ed99086017f00000000000000000000000000000000000000000000000000000000000000006120d7565b600290810b60408d015260208c01517f0000000000000000000000000000000000000000000000000000000000000000820b910b1215612f3d577f000000000000000000000000000000000000000000000000000000000000000060020b60208c01525b7f000000000000000000000000000000000000000000000000000000000000000060020b8b6040015160020b1315612f99577f000000000000000000000000000000000000000000000000000000000000000060020b60408c01525b8b51612fac90610d8e908d908787613fd7565b9094509250881561301557612ff4612fc48584614e1b565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690613ffe565b612ffe8483614e1b565b6007600082825461300f9190614dbb565b90915550505b8715613079576130586130288483614e1b565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690613ffe565b6130628382614e1b565b600860008282546130739190614dbb565b90915550505b7fe73e1a034909b10f2cbe101ce0618d683b1485c1c2da61474bdbebce08bcaf1a8b602001518c604001516040516130c1929190600292830b8152910b602082015260400190565b60405180910390a150989a9950505050505050505050565b60006001600160a01b03861661313557604080516000808252602082015263ffffffff87168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a150806134f4565b6001600160a01b0386166000908152600b60205260408120549061317361316263ffffffff881684614f74565b8863ffffffff16633b9aca006122d8565b90507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b0316141561323557600954808211806131be575082155b156131c7578091505b6131d18282614e1b565b905060006131f26131e3601486614f74565b8863ffffffff166127106122d8565b90508082116132015781613203565b805b60095580821115613217576001955061322e565b613222600482614ed0565b82101561322e57600095505b5050613470565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b031614156132c857600a548082118061327e575082155b15613287578091505b6132918282614e1b565b905060006132a36131e3601486614f74565b90508082116132b257816132b4565b805b600a5580821115613217576001955061322e565b6040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a0823190602401602060405180830381865afa15801561330f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133339190614ea1565b905080821180613341575082155b1561334a578091505b60405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa1580156133b0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133d49190614f93565b8015613465575060405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa158015613441573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906134659190614f93565b61346e57600080fd5b505b6134846001600160a01b03891633836139f1565b6134a08861349b612710848a63ffffffff166122d8565b61401d565b604080516001600160a01b038a1681526020810183905263ffffffff89168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a183925050505b95945050505050565b806040015160020b816020015160020b14156135165750565b600061352182613909565b505050509050806001600160801b03166000146123e65781516020830151604080850151905163a34123a760e01b8152600292830b6004820152910b6024820152600060448201526001600160a01b039091169063a34123a79060640160408051808303816000875af115801561359c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611e719190614f06565b600080808815806135d057508715155b806135da57508615155b6135e6576135e6614fae565b8861365b5760006136056001600160a01b03861680600160601b6122d8565b905061361f86600160601b836001600160e01b03166122d8565b92508683101561363457859150819350613655565b86925061364f83826001600160e01b0316600160601b6122d8565b91508293505b506136fa565b8761367457508361366d818a896122d8565b92506136fa565b866136875785915061366d828a8a6122d8565b60008789106136a25761369b87898b6122d8565b86106136b0565b866136ae878b8b6122d8565b105b905080156136da578591506136c6828a8a6122d8565b92506136d3828b8a6122d8565b93506136f8565b8692506136e883898b6122d8565b91506136f5838b8b6122d8565b93505b505b96509650969350505050565b6040516001600160a01b0380851660248301528316604482015260648101829052611e719085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091526140f1565b806002600082825461379b9190614dbb565b90915550506001600160a01b0382166000818152600360209081526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91015b60405180910390a35050565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60006040516138279190614fc4565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b6040516024810182905261390490632e1a7d4d60e01b906044015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091526001600160a01b03841690613a95565b505050565b600080600080600085600001516001600160a01b031663514ea4bf308860200151896040015160405160200161396a9392919060609390931b6bffffffffffffffffffffffff1916835260e891821b6014840152901b6017820152601a0190565b604051602081830303815290604052805190602001206040518263ffffffff1660e01b815260040161399e91815260200190565b60a060405180830381865afa1580156139bb573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906139df9190615060565b939a9299509097509550909350915050565b6040516001600160a01b03831660248201526044810182905261390490849063a9059cbb60e01b9060640161373a565b6001600160a01b03821660009081526003602052604081208054839290613a49908490614e1b565b90915550506002805482900390556040518181526000906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020016137e9565b606061124a8383604051806060016040528060278152602001615258602791396141d6565b600080613ae184613ace8760200151613aed565b613adb8860400151613aed565b866142c1565b91509150935093915050565b60008060008360020b12613b04578260020b613b11565b8260020b613b11906150b7565b9050613b20620d89e7196150d4565b62ffffff16811115613b585760405162461bcd60e51b81526020600482015260016024820152601560fa1b60448201526064016112aa565b600060018216613b7957700100000000000000000000000000000000613b8b565b6ffffcb933bd6fad37aa2d162d1a5940015b70ffffffffffffffffffffffffffffffffff1690506002821615613bbf576ffff97272373d413259a46990580e213a0260801c5b6004821615613bde576ffff2e50f5f656932ef12357cf3c7fdcc0260801c5b6008821615613bfd576fffe5caca7e10e4e61c3624eaa0941cd00260801c5b6010821615613c1c576fffcb9843d60f6159c9db58835c9266440260801c5b6020821615613c3b576fff973b41fa98c081472e6896dfb254c00260801c5b6040821615613c5a576fff2ea16466c96a3843ec78b326b528610260801c5b6080821615613c79576ffe5dee046a99a2a811c461f1969c30530260801c5b610100821615613c99576ffcbe86c7900a88aedcffc83b479aa3a40260801c5b610200821615613cb9576ff987a7253ac413176f2b074cf7815e540260801c5b610400821615613cd9576ff3392b0822b70005940c7a398e4b70f30260801c5b610800821615613cf9576fe7159475a2c29b7443b29c7fa6e889d90260801c5b611000821615613d19576fd097f3bdfd2022b8845ad8f792aa58250260801c5b612000821615613d39576fa9f746462d870fdf8a65dc1f90e061e50260801c5b614000821615613d59576f70d869a156d2a1b890bb3df62baf32f70260801c5b618000821615613d79576f31be135f97d08fd981231505542fcfa60260801c5b62010000821615613d9a576f09aa508b5b7a84e1c677de54f3e99bc90260801c5b62020000821615613dba576e5d6af8dedb81196699c329225ee6040260801c5b62040000821615613dd9576d2216e584f5fa1ea926041bedfe980260801c5b62080000821615613df6576b048a170391f7dc42444e8fa20260801c5b60008460020b1315613e17578060001981613e1357613e13614eba565b0490505b640100000000810615613e2b576001613e2e565b60005b60ff16602082901c0192505050919050565b6000826001600160a01b0316846001600160a01b03161115613e60579192915b613e89613e8483600160601b613e7688886150f7565b6001600160a01b03166122d8565b6143a3565b949350505050565b6000826001600160a01b0316846001600160a01b03161115613eb1579192915b6000613ed4856001600160a01b0316856001600160a01b0316600160601b6122d8565b90506134f4613e848483613e7689896150f7565b6000662358b99a116be08211613f015750610192919050565b67053448a4815102008210613f195750616c50919050565b613f24600283614f74565b91506000670de0b6b3a7640000839003730de0b6b3a764000000000000000000000000000081613f5657613f56614eba565b04905061124a816143be565b60008080613f77613f72856150d4565b613aed565b613f8e906001600160a01b0316600160601b614e1b565b9050613fad86826bffffffffffffffffffffffff16600160601b6122d8565b9250613fcc85826bffffffffffffffffffffffff16600160601b6122d8565b915050935093915050565b60006134f484613fea8760200151613aed565b613ff78860400151613aed565b8686614705565b604051602481018290526139049063b6b55f2560e01b906044016138aa565b6001600160a01b0382166000908152600c60209081526040808320600d835281842054600b90935292205460ff90911690600a8104810380851015614060578094505b600e85049450838360ff16600e811061407b5761407b61511f565b01546001600160a01b0387166000908152600b60205260409020838701919091039055848460ff8516600e81106140b4576140b461511f565b0155600e60ff60018501166001600160a01b03979097166000908152600d60205260409020805460ff19169190970660ff16179095555050505050565b6000614146826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166147bd9092919063ffffffff16565b80519091501561390457808060200190518101906141649190614f93565b6139045760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f7420737563636565640000000000000000000000000000000000000000000060648201526084016112aa565b6060833b61424c5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f60448201527f6e7472616374000000000000000000000000000000000000000000000000000060648201526084016112aa565b600080856001600160a01b0316856040516142679190615135565b600060405180830381855af49150503d80600081146142a2576040519150601f19603f3d011682016040523d82523d6000602084013e6142a7565b606091505b50915091506142b78282866147cc565b9695505050505050565b600080836001600160a01b0316856001600160a01b031611156142e2579293925b846001600160a01b0316866001600160a01b03161161431657614306858585614805565b6001600160e01b0316915061439a565b836001600160a01b0316866001600160a01b031610156143725761433b868585614805565b6001600160e01b03169150614351858785614893565b77ffffffffffffffffffffffffffffffffffffffffffffffff16905061439a565b61437d858585614893565b77ffffffffffffffffffffffffffffffffffffffffffffffff1690505b94509492505050565b806001600160801b03811681146143b957600080fd5b919050565b60006401000276a36001600160a01b038316108015906143fa575073fffd8963efd1fc6a506488495d951d5263988d266001600160a01b038316105b61442a5760405162461bcd60e51b81526020600482015260016024820152602960f91b60448201526064016112aa565b77ffffffffffffffffffffffffffffffffffffffff00000000602083901b166001600160801b03811160071b81811c67ffffffffffffffff811160061b90811c63ffffffff811160051b90811c61ffff811160041b90811c60ff8111600390811b91821c600f811160021b90811c918211600190811b92831c979088119617909417909217179091171717608081106144d2576144c8607f82614e1b565b83901c91506144e3565b6144dd81607f614e1b565b83901b91505b600060406144f2608084615151565b901b9050828302607f1c92508260801c80603f1b8217915083811c935050828302607f1c92508260801c80603e1b8217915083811c935050828302607f1c92508260801c80603d1b8217915083811c935050828302607f1c92508260801c80603c1b8217915083811c935050828302607f1c92508260801c80603b1b8217915083811c935050828302607f1c92508260801c80603a1b8217915083811c935050828302607f1c92508260801c8060391b8217915083811c935050828302607f1c92508260801c8060381b8217915083811c935050828302607f1c92508260801c8060371b8217915083811c935050828302607f1c92508260801c8060361b8217915083811c935050828302607f1c92508260801c8060351b8217915083811c935050828302607f1c92508260801c8060341b8217915083811c935050828302607f1c92508260801c8060331b8217915083811c935050828302607f1c92508260801c8060321b8217915050600081693627a301d71055774c856146759190615190565b9050600060806146956f028f6481ab7f045a5af012a19d003aaa84615151565b901d9050600060806146b7846fdb2df09e81959a81455e260799a0632f615217565b901d90508060020b8260020b146146f657886001600160a01b03166146db82613aed565b6001600160a01b031611156146f057816146f8565b806146f8565b815b9998505050505050505050565b6000836001600160a01b0316856001600160a01b03161115614725579293925b846001600160a01b0316866001600160a01b03161161475057614749858585613e91565b90506134f4565b836001600160a01b0316866001600160a01b031610156147b2576000614777878686613e91565b90506000614786878986613e40565b9050806001600160801b0316826001600160801b0316106147a757806147a9565b815b925050506134f4565b6142b7858584613e40565b6060613e8984846000856148dd565b606083156147db57508161124a565b8251156147eb5782518084602001fd5b8160405162461bcd60e51b81526004016112aa9190614a48565b6000826001600160a01b0316846001600160a01b03161115614825579192915b6001600160a01b0384166148777bffffffffffffffffffffffffffffffff000000000000000000000000606085901b1661485f87876150f7565b6001600160a01b0316866001600160a01b03166122d8565b6148819190614ed0565b67ffffffffffffffff16949350505050565b6000826001600160a01b0316846001600160a01b031611156148b3579192915b613e896001600160801b0383166148ca86866150f7565b6001600160a01b0316600160601b6122d8565b6060824710156149555760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c000000000000000000000000000000000000000000000000000060648201526084016112aa565b843b6149a35760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e747261637400000060448201526064016112aa565b600080866001600160a01b031685876040516149bf9190615135565b60006040518083038185875af1925050503d80600081146149fc576040519150601f19603f3d011682016040523d82523d6000602084013e614a01565b606091505b5091509150614a118282866147cc565b979650505050505050565b60005b83811015614a37578181015183820152602001614a1f565b83811115611e715750506000910152565b6020815260008251806020840152614a67816040850160208701614a1c565b601f01601f19169190910160400192915050565b6001600160a01b0381168114614a9057600080fd5b50565b60008060408385031215614aa657600080fd5b8235614ab181614a7b565b946020939093013593505050565b600060208284031215614ad157600080fd5b813561124a81614a7b565b600080600060608486031215614af157600080fd5b8335614afc81614a7b565b92506020840135614b0c81614a7b565b929592945050506040919091013590565b60008060008060808587031215614b3357600080fd5b5050823594602084013594506040840135936060013592509050565b600080600060608486031215614b6457600080fd5b505081359360208301359350604090920135919050565b60008060008060608587031215614b9157600080fd5b8435935060208501359250604085013567ffffffffffffffff80821115614bb757600080fd5b818701915087601f830112614bcb57600080fd5b813581811115614bda57600080fd5b886020828501011115614bec57600080fd5b95989497505060200194505050565b60ff81168114614a9057600080fd5b600080600080600080600060e0888a031215614c2557600080fd5b8735614c3081614a7b565b96506020880135614c4081614a7b565b955060408801359450606088013593506080880135614c5e81614bfb565b9699959850939692959460a0840135945060c09093013592915050565b60008060408385031215614c8e57600080fd5b8235614c9981614a7b565b91506020830135614ca981614a7b565b809150509250929050565b600181811c90821680614cc857607f821691505b60208210811415614ce957634e487b7160e01b600052602260045260246000fd5b50919050565b805161ffff811681146143b957600080fd5b805180151581146143b957600080fd5b600080600080600080600060e0888a031215614d2c57600080fd5b8751614d3781614a7b565b8097505060208801518060020b8114614d4f57600080fd5b9550614d5d60408901614cef565b9450614d6b60608901614cef565b9350614d7960808901614cef565b925060a0880151614d8981614bfb565b9150614d9760c08901614d01565b905092959891949750929550565b634e487b7160e01b600052601160045260246000fd5b60008219821115614dce57614dce614da5565b500190565b60008160020b8360020b6000811281627fffff1901831281151615614dfa57614dfa614da5565b81627fffff018313811615614e1157614e11614da5565b5090039392505050565b600082821015614e2d57614e2d614da5565b500390565b60008160020b8360020b6000821282627fffff03821381151615614e5857614e58614da5565b82627fffff19038212811615614e7057614e70614da5565b50019392505050565b600063ffffffff808316818516808303821115614e9857614e98614da5565b01949350505050565b600060208284031215614eb357600080fd5b5051919050565b634e487b7160e01b600052601260045260246000fd5b600082614edf57614edf614eba565b500490565b60008260020b80614ef757614ef7614eba565b808360020b0791505092915050565b60008060408385031215614f1957600080fd5b505080516020909101519092909150565b80516001600160801b03811681146143b957600080fd5b60008060408385031215614f5457600080fd5b614f5d83614f2a565b9150614f6b60208401614f2a565b90509250929050565b6000816000190483118215151615614f8e57614f8e614da5565b500290565b600060208284031215614fa557600080fd5b61124a82614d01565b634e487b7160e01b600052600160045260246000fd5b600080835481600182811c915080831680614fe057607f831692505b602080841082141561500057634e487b7160e01b86526022600452602486fd5b818015615014576001811461502557615052565b60ff19861689528489019650615052565b60008a81526020902060005b8681101561504a5781548b820152908501908301615031565b505084890196505b509498975050505050505050565b600080600080600060a0868803121561507857600080fd5b61508186614f2a565b9450602086015193506040860151925061509d60608701614f2a565b91506150ab60808701614f2a565b90509295509295909350565b6000600160ff1b8214156150cd576150cd614da5565b5060000390565b60008160020b627fffff198114156150ee576150ee614da5565b60000392915050565b60006001600160a01b038381169083168181101561511757615117614da5565b039392505050565b634e487b7160e01b600052603260045260246000fd5b60008251615147818460208701614a1c565b9190910192915050565b60008083128015600160ff1b85018412161561516f5761516f614da5565b836001600160ff1b0301831381161561518a5761518a614da5565b50500390565b60006001600160ff1b036000841360008413858304851182821616156151b8576151b8614da5565b600160ff1b60008712828116878305891216156151d7576151d7614da5565b600087129250878205871284841616156151f3576151f3614da5565b8785058712818416161561520957615209614da5565b505050929093029392505050565b6000808212826001600160ff1b030384138115161561523857615238614da5565b600160ff1b839003841281161561525157615251614da5565b5050019056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a26469706673582212205a3e3f86355b7adff0998ba564b6616ac8044f82f2897c29f5097ab8f9dc581c64736f6c634300080a0033";
const UINT256MAX = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

const ADDRESS_UNI_POOL = "0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640";
const ADDRESS_CTOKEN0 = "0x39AA39c021dfbaE8faC545936693aC917d5E7563";
const ADDRESS_CTOKEN1 = "0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5";
const WHALE = "0x4F868C1aa37fCf307ab38D215382e88FCA6275E2";

function prettyPrintRebalance(tx) {
  console.log("⚖️ The vault was rebalanced!");
  for (const log of tx.logs) {
    console.log(`\t${log.event}`);

    if (log.event === "Recenter") {
      const lower = log.args.lower.toNumber();
      const upper = log.args.upper.toNumber();
      const middle = Math.round((lower + upper) / 2);

      console.log(`\t   || ${lower} |======> ${middle} <======| ${upper} ||`);
    } else if (log.event === "Reward") {
      const token = log.args.token;
      const amount = log.args.amount.toNumber();
      const urgency = log.args.urgency.toNumber();

      console.log(`\t   urgency=${urgency / 1e5} ---> ${amount / 1e9} of ${token.slice(0, 6)}`);
    } else if (log.event === "Rebalance") {
      const ratio = log.args.ratio.toString(0);
      const shares = log.args.shares.toString(0);
      const inventory0 = log.args.inventory0.toString(0);
      const inventory1 = log.args.inventory1.toString(0);

      console.log(`\t   ratio=${ratio}  (${inventory0} / ${inventory1})`);
      console.log(`\t   ${shares} outstanding shares`);
    } else if (log.event === "Transfer") {
      let from = log.args.from;
      let to = log.args.to;
      const amount = log.args.amount.toString(0);

      if (from === ADDRESS_UNI_POOL) from = "Uniswap";
      else if (from === ADDRESS_CTOKEN0) from = "silo0";
      else if (from === ADDRESS_CTOKEN1) from = "silo1";
      if (to === ADDRESS_UNI_POOL) to = "Uniswap";
      else if (to === ADDRESS_CTOKEN0) to = "silo0";
      else if (to === ADDRESS_CTOKEN1) to = "silo1";

      console.log(`\t   (${log.address.slice(0, 7)})`);
      console.log(`\t   ${amount} from ${from.slice(0, 7)} to ${to.slice(0, 7)}`);
    }
  }
}

describe("USDC-WETH 0.05% | cUSDC | cETH @hardhat", () => {

  let accounts;
  let multisig;

  let aloeBlend;
  let factory;
  let oracle;
  let silo0;
  let silo1;

  let token0;
  let token1;

  before(async () => {
    await web3.eth.hardhat.reset({
      forking: {
        jsonRpcUrl: `https://eth-mainnet.alchemyapi.io/v2/${process.env.PROVIDER_ALCHEMY_KEY}`,
        blockNumber: 12802299,
      },
      accounts: [
        {
          privateKey: "0101010101010101010101010101010101010101010101010101010101010101",
          balance: "2000000000000000000",
        },
        {
          privateKey: process.env.DEPLOYER,
          balance: "2000000000000000000",
        },
      ],
    });
  });

  it("should deploy", async () => {
    accounts = await web3.eth.getAccounts();
    multisig = accounts[0];

    const deployer = web3.eth.accounts.privateKeyToAccount(process.env.DEPLOYER);

    oracle = await VolatilityOracle.new();
    factory = await Factory.new(oracle.address, BYTECODE);
    silo0 = await CompoundCTokenSilo.new(ADDRESS_CTOKEN0, {
      from: deployer.address,
    });
    silo1 = await CompoundCEtherSilo.new(ADDRESS_CTOKEN1, {
      from: deployer.address,
    });

    await factory.createVault(ADDRESS_UNI_POOL, silo0.address, silo1.address, {
      from: deployer.address,
    });
    const vaultAddress = await factory.getVault(ADDRESS_UNI_POOL, silo0.address, silo1.address);
    aloeBlend = await AloeBlend.at(vaultAddress);
    token0 = await ERC20.at(await aloeBlend.TOKEN0());
    token1 = await ERC20.at(await aloeBlend.TOKEN1());
  });

  it("should get inventory (zero)", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("0");
    expect(res.inventory1.toString(10)).to.equal("0");
  });

  it("should impersonate whale", async () => {
    await web3.eth.hardhat.impersonate(WHALE);

    const balance0 = await token0.balanceOf(WHALE);
    const balance1 = await token1.balanceOf(WHALE);

    expect(balance0.gt(2000e6)).to.be.true;
    expect(balance1.gt(1e18)).to.be.true;
  });

  it("should fail to deposit before approving tokens", async () => {
    const tx = aloeBlend.deposit("100000000", "100000000000000000", 0, 0, {
      from: WHALE,
    });
    await expect(tx).to.eventually.be.rejectedWith(
      Error,
      "VM Exception while processing transaction: reverted with reason string 'ERC20: transfer amount exceeds allowance'"
    );
  });

  it("should approve tokens for vault management", async () => {
    const tx0 = await token0.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    const tx1 = await token1.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    expect(tx0.receipt.status).to.be.true;
    expect(tx1.receipt.status).to.be.true;
  });

  it("should deposit", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "50000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("100000000");
    expect(deposit.args.amount0.toString(10)).to.equal("100000000");
    expect(deposit.args.amount1.toString(10)).to.equal("47451794160948057");
  });

  it("should deposit proportionally", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "40000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("84296075");
    expect(deposit.args.amount0.toString(10)).to.equal("84296075");
    expect(deposit.args.amount1.toString(10)).to.equal("40000000000000000");
  });

  it("should rebalance", async () => {
    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589708047402); // 5% of inventory1 (contract float)

    const urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should go to next block", async () => {
    await web3.eth.hardhat.mine();
  });

  it("should get inventory before rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794076657509");
  });

  it("should rebalance again", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(1);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4380941078269389); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory after rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296074");
    expect(res.inventory1.toString(10)).to.equal("87451794079037807");
  });

  it("should rebalance a third time", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589705422976); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory once more", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794088820670");
  });

  it("should withdraw", async () => {
    const shares = (await aloeBlend.balanceOf(WHALE)).toNumber();
    expect(shares).to.equal(184296075);

    const tx0 = await aloeBlend.withdraw("184296075", 0, 0, { from: WHALE });
    const withdraw = tx0.logs[tx0.logs.length - 1];
    expect(withdraw.event).to.equal("Withdraw");
    expect(withdraw.args.shares.toString(10)).to.equal("184296075");
    expect(withdraw.args.amount0.toString(10)).to.equal("184296074");
    expect(withdraw.args.amount1.toString(10)).to.equal("87451794118248630");

    console.log((await token0.balanceOf(aloeBlend.address)).toString(10));
    console.log((await token1.balanceOf(aloeBlend.address)).toString(10));
  });
});
