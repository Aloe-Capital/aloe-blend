const chai = require("chai");
const chaiAsPromised = require("chai-as-promised");
const { artifacts } = require("hardhat");

const ERC20 = artifacts.require("@openzeppelin/contracts/token/ERC20/IERC20.sol:IERC20");

const AloeBlend = artifacts.require("AloeBlend");
const Factory = artifacts.require("Factory");
const VolatilityOracle = artifacts.require("VolatilityOracle");

const CompoundCEtherSilo = artifacts.require("CompoundCEtherSilo");
const CompoundCTokenSilo = artifacts.require("CompoundCTokenSilo");

chai.use(chaiAsPromised);
const expect = chai.expect;

web3.eth.extend({
  property: "hardhat",
  methods: [
    {
      name: "increaseTime",
      call: "evm_increaseTime",
      params: 1,
    },
    {
      name: "mine",
      call: "evm_mine",
      params: 0,
    },
    {
      name: "impersonate",
      call: "hardhat_impersonateAccount",
      params: 1,
    },
    {
      name: "stopImpersonating",
      call: "hardhat_stopImpersonatingAccount",
      params: 1,
    },
    {
      name: "reset",
      call: "hardhat_reset",
      params: 1,
      /*
      {
        forking: {
          jsonRpcUrl: "https://eth-mainnet.alchemyapi.io/v2/<key>",
          blockNumber: 11095000,
        },
      }
      */
    },
  ],
});

const BYTECODE =
  "0x6102006040523480156200001257600080fd5b5060405162005e5838038062005e5883398101604081905262000035916200067a565b82836001600160a01b0316630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000075573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200009b9190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620000d9573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526200010391908101906200073e565b846001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000142573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620001689190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620001a6573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052620001d091908101906200073e565b604051602001620001e3929190620007f6565b604051602081830303815290604052806040518060400160405280600a815260200169105313d14b509311539160b21b8152506012826000908051906020019062000230929190620005bb565b50815162000246906001906020850190620005bb565b5060ff81166080524660a0526200025c620004ba565b60c052505050506001600160a01b03811660e081905260408051630dfe168160e01b81529051630dfe1681916004808201926020929091908290030181865afa158015620002ae573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620002d49190620006ce565b6001600160a01b0316610100816001600160a01b031681525050806001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156200032d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003539190620006ce565b6001600160a01b0316610120816001600160a01b031681525050806001600160a01b031663d0c93a7c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015620003ac573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003d291906200084d565b60020b6101408160020b8152505050620003ff620d89e719610140516200055660201b620020bc1760201c565b60020b610160526200042e62000419620d89e71962000872565b610140516200058b60201b620020eb1760201c565b60020b61018052604080516355b13a4f60e01b8152905133916355b13a4f9160048083019260209291908290030181865afa15801562000472573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620004989190620006ce565b6001600160a01b039081166101a0529182166101c052166101e05250620009b6565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6000604051620004ee9190620008e1565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b60008062000565838562000985565b905060008160020b1315620005805783038201905062000585565b830390505b92915050565b6000806200059a838562000985565b905060008160020b12620005b2578303905062000585565b90920303919050565b828054620005c990620008a4565b90600052602060002090601f016020900481019282620005ed576000855562000638565b82601f106200060857805160ff191683800117855562000638565b8280016001018555821562000638579182015b82811115620006385782518255916020019190600101906200061b565b50620006469291506200064a565b5090565b5b808211156200064657600081556001016200064b565b6001600160a01b03811681146200067757600080fd5b50565b6000806000606084860312156200069057600080fd5b83516200069d8162000661565b6020850151909350620006b08162000661565b6040850151909250620006c38162000661565b809150509250925092565b600060208284031215620006e157600080fd5b8151620006ee8162000661565b9392505050565b634e487b7160e01b600052604160045260246000fd5b60005b83811015620007285781810151838201526020016200070e565b8381111562000738576000848401525b50505050565b6000602082840312156200075157600080fd5b81516001600160401b03808211156200076957600080fd5b818401915084601f8301126200077e57600080fd5b815181811115620007935762000793620006f5565b604051601f8201601f19908116603f01168101908382118183101715620007be57620007be620006f5565b81604052828152876020848701011115620007d857600080fd5b620007eb8360208301602088016200070b565b979650505050505050565b6a020b637b290213632b732160ad1b8152600083516200081e81600b8501602088016200070b565b602f60f81b600b9184019182015283516200084181600c8401602088016200070b565b01600c01949350505050565b6000602082840312156200086057600080fd5b81518060020b8114620006ee57600080fd5b60008160020b627fffff198114156200089b57634e487b7160e01b600052601160045260246000fd5b60000392915050565b600181811c90821680620008b957607f821691505b60208210811415620008db57634e487b7160e01b600052602260045260246000fd5b50919050565b600080835481600182811c915080831680620008fe57607f831692505b60208084108214156200091f57634e487b7160e01b86526022600452602486fd5b818015620009365760018114620009485762000977565b60ff1986168952848901965062000977565b60008a81526020902060005b868110156200096f5781548b82015290850190830162000954565b505084890196505b509498975050505050505050565b60008260020b80620009a757634e487b7160e01b600052601260045260246000fd5b808360020b0791505092915050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e0516152c762000b916000396000818161090d01528181610b7b01528181611307015281816117620152818161191f015281816119ee015281816125800152818161296401528181612a0d0152818161302f01526133f701526000818161055601528181610b49015281816112d501528181611738015281816117c5015281816118a50152818161248d01528181612ba101528181612c4a01528181612fcb01526133660152600081816104c40152612d72015260008181612f3c0152612f6e015260008181612ee70152612f12015260008181610c3801528181610c7d01528181610cc401528181610d9601528181610ddb01528181610e2201528181612e790152612eb20152600081816105220152818161150c01528181611c8401528181611e2f015281816128d00152613234015260008181610478015281816114d701528181611c5001528181611df501528181612b54015261317401526000818161067b01528181610a7e015281816113380152818161161501528181611db801528181612205015281816122570152612d33015260006115da015260006115a50152600061040801526152c76000f3fe6080604052600436106102a45760003560e01c8063819b71c81161016e578063c3bd5945116100cb578063d5ffb4e51161007f578063da3848db11610064578063da3848db146107f3578063dd62ed3e146108c3578063e035814d146108fb57600080fd5b8063d5ffb4e5146107b2578063d785598e146107dd57600080fd5b8063d0c9bdb4116100b0578063d0c9bdb414610748578063d348799714610772578063d505accf1461079257600080fd5b8063c3bd59451461071c578063c620033f1461073257600080fd5b80639f13f76d11610122578063a9059cbb11610107578063a9059cbb146106d2578063a932492f146106f2578063ad1383f81461070757600080fd5b80639f13f76d1461069d578063a41fe49f146106b257600080fd5b806388a9f8bb1161015357806388a9f8bb1461063e57806395d89b41146106545780639b1475581461066957600080fd5b8063819b71c8146105ff57806383db382d1461061557600080fd5b806332e7c5bf1161021c5780635ee04d78116101d057806370a08231116101b557806370a08231146105785780637ecebe00146105a55780637f86d13c146105d257600080fd5b80635ee04d781461051057806362d7d45e1461054457600080fd5b8063443ec74d11610201578063443ec74d1461046657806355b13a4f146104b25780635d7f850c146104e657600080fd5b806332e7c5bf1461043c5780633644e5151461045157600080fd5b806321c28191116102735780632505c3d9116102585780632505c3d91461038757806330adf81f146103c2578063313ce567146103f657600080fd5b806321c281911461034557806323b872dd1461036757600080fd5b806306fdde03146102b0578063095ea7b3146102db5780631304fd581461030b57806318160ddd1461032f57600080fd5b366102ab57005b600080fd5b3480156102bc57600080fd5b506102c561092f565b6040516102d29190614a5b565b60405180910390f35b3480156102e757600080fd5b506102fb6102f6366004614aa6565b6109bd565b60405190151581526020016102d2565b34801561031757600080fd5b5061032160095481565b6040519081526020016102d2565b34801561033b57600080fd5b5061032160025481565b34801561035157600080fd5b50610365610360366004614ad2565b610a2a565b005b34801561037357600080fd5b506102fb610382366004614aef565b611142565b34801561039357600080fd5b506103a76103a2366004614b30565b611236565b604080519384526020840192909252908201526060016102d2565b3480156103ce57600080fd5b506103217f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c981565b34801561040257600080fd5b5061042a7f000000000000000000000000000000000000000000000000000000000000000081565b60405160ff90911681526020016102d2565b34801561044857600080fd5b5061042a600281565b34801561045d57600080fd5b506103216115a1565b34801561047257600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020016102d2565b3480156104be57600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b3480156104f257600080fd5b506104fb6115fc565b604080519283526020830191909152016102d2565b34801561051c57600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b34801561055057600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b34801561058457600080fd5b50610321610593366004614ad2565b60036020526000908152604090205481565b3480156105b157600080fd5b506103216105c0366004614ad2565b60056020526000908152604090205481565b3480156105de57600080fd5b506103216105ed366004614ad2565b600b6020526000908152604090205481565b34801561060b57600080fd5b5061032160085481565b34801561062157600080fd5b5061062b61019281565b60405160029190910b81526020016102d2565b34801561064a57600080fd5b506103216101f481565b34801561066057600080fd5b506102c56116b7565b34801561067557600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b3480156106a957600080fd5b5061042a600481565b3480156106be57600080fd5b506104fb6106cd366004614b62565b6116c4565b3480156106de57600080fd5b506102fb6106ed366004614aa6565b611d17565b3480156106fe57600080fd5b5061042a601481565b34801561071357600080fd5b5061042a600a81565b34801561072857600080fd5b50610321600a5481565b34801561073e57600080fd5b5061062b616c5081565b34801561075457600080fd5b5061075d611d8f565b60405163ffffffff90911681526020016102d2565b34801561077e57600080fd5b5061036561078d366004614b8e565b611dad565b34801561079e57600080fd5b506103656107ad366004614c1d565b611e5c565b3480156107be57600080fd5b506107c96201518081565b60405162ffffff90911681526020016102d2565b3480156107e957600080fd5b5061032160075481565b3480156107ff57600080fd5b5060065461086a90600281810b9163010000008104820b9166010000000000008204810b916901000000000000000000810490910b9065ffffffffffff600160601b8204169063ffffffff600160901b8204169060ff600160b01b8204811691600160b81b90041688565b604080516002998a0b815297890b602089015295880b958701959095529290950b606085015265ffffffffffff16608084015263ffffffff90931660a083015291151560c082015290151560e0820152610100016102d2565b3480156108cf57600080fd5b506103216108de366004614c8e565b600460209081526000928352604080842090915290825290205481565b34801561090757600080fd5b5061049a7f000000000000000000000000000000000000000000000000000000000000000081565b6000805461093c90614cc7565b80601f016020809104026020016040519081016040528092919081815260200182805461096890614cc7565b80156109b55780601f1061098a576101008083540402835291602001916109b5565b820191906000526020600020905b81548152906001019060200180831161099857829003601f168201915b505050505081565b3360008181526004602090815260408083206001600160a01b038716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92590610a189086815260200190565b60405180910390a35060015b92915050565b60005a90506000806000806000610a3f612117565b6006805460ff60b81b1916600160b81b1790556040805160608101825260008082526020820181905291810191909152949950929750909550935091507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa158015610ada573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610afe9190614d24565b5050505060029190910b6040840152506001600160a01b0316808252610b299080600160601b6122bd565b6001600160e01b031660208201526000610b428561236a565b9050610b767f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031661238e565b610ba87f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031661238e565b6000806000610bbe8a8a876000015160006123cf565b92509250925080606001516001600160801b0316600014610bee576060810151610be9908a90612740565b505050505b6000610c2261271085610c1386600160601b8b602001516001600160e01b03166122bd565b610c1d9088614dce565b6122bd565b9050611324811015610d8257610c5c86604001517f00000000000000000000000000000000000000000000000000000000000000006120eb565b60020b60408b015260608201516001600160801b031615801590610cb857507f00000000000000000000000000000000000000000000000000000000000000008a60400151610cab9190614de6565b60020b8a6020015160020b145b15610cc257600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60400151610cf29190614de6565b60020b6020808c0191909152860151600090600190610d209087906001600160e01b0316600160601b6122bd565b610d2a9086614e2e565b901c90508260200151811115610d41575060208201515b6000610d4b6128ac565b905081811015610d6557610d60818303612946565b810191505b50610d7a610d738c83612a48565b8c90612a6d565b505050610f01565b6113ec811115610eca57610dba86604001517f00000000000000000000000000000000000000000000000000000000000000006120bc565b60020b60208b015260608201516001600160801b031615801590610e1657507f00000000000000000000000000000000000000000000000000000000000000008a60200151610e099190614e45565b60020b8a6040015160020b145b15610e2057600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60200151610e509190614e45565b60020b60408b01526020860151600090600190610e7d908690600160601b906001600160e01b03166122bd565b610e879087614e2e565b8451911c9150811115610e98575081515b6000610ea2612b30565b905081811015610ebc57610eb7818303612b83565b810191505b50610d7a610d738c83612c85565b60408051606081018252600080825260208201819052918101919091529950610efb868c846040015187878c612caa565b9a504298505b5a610f0e8d615208614e8c565b63ffffffff16610f1e9190614e2e565b9b508763ffffffff168c63ffffffff161115610f38578b97505b610f458d868e8b8b6130d6565b6002546040805184815260208101929092528101869052606081018590529097507f802a0d65ee1ffb3e6af96deafe1fc3e6402b2672a2f4b79d1b23c4a06c998f349060800160405180910390a16040518061010001604052808c6020015160020b81526020018c6040015160020b81526020018b6020015160020b81526020018b6040015160020b81526020018a65ffffffffffff1681526020018963ffffffff168152602001881515815260200160001515815250600660008201518160000160006101000a81548162ffffff021916908360020b62ffffff16021790555060208201518160000160036101000a81548162ffffff021916908360020b62ffffff16021790555060408201518160000160066101000a81548162ffffff021916908360020b62ffffff16021790555060608201518160000160096101000a81548162ffffff021916908360020b62ffffff160217905550608082015181600001600c6101000a81548165ffffffffffff021916908365ffffffffffff16021790555060a08201518160000160126101000a81548163ffffffff021916908363ffffffff16021790555060c08201518160000160166101000a81548160ff02191690831515021790555060e08201518160000160176101000a81548160ff02191690831515021790555090505050505050505050505050505050565b6001600160a01b0383166000908152600460209081526040808320338452909152812054600019811461119e576111798382614e2e565b6001600160a01b03861660009081526004602090815260408083203384529091529020555b6001600160a01b038516600090815260036020526040812080548592906111c6908490614e2e565b90915550506001600160a01b03808516600081815260036020526040908190208054870190555190918716907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906112219087815260200190565b60405180910390a360019150505b9392505050565b600080808615158061124757508515155b6112985760405162461bcd60e51b815260206004820152600f60248201527f416c6f653a2030206465706f736974000000000000000000000000000000000060448201526064015b60405180910390fd5b6000806112a3612117565b50506006805460ff60b81b1916600160b81b1790555090925090506112c7826134fa565b6112d0816134fa565b6113027f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031661238e565b6113347f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031661238e565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa158015611394573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113b89190614d24565b50505050505090506000806113d085858560016123cf565b50915091506113e560025483838f8f886135bd565b919950975095508761142a5760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b604482015260640161128f565b8987101561147a5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f770000000000000000000000604482015260640161128f565b888610156114ca5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f770000000000000000000000604482015260640161128f565b6114ff6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633308a613703565b6115346001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016333089613703565b61153e3389613786565b604080518981526020810189905290810187905233907f36af321ec8d3c75236829c5317affd40ddb308863a1236d2d277a4025cccee1e9060600160405180910390a250506006805460ff60b81b19169055509398929750909550909350505050565b60007f000000000000000000000000000000000000000000000000000000000000000046146115d7576115d26137f2565b905090565b507f000000000000000000000000000000000000000000000000000000000000000090565b60008060008061160a612117565b5050509150915060007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa158015611671573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116959190614d24565b50505050505090506116aa83838360006123cf565b5090969095509350505050565b6001805461093c90614cc7565b600080846117055760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b604482015260640161128f565b600080611710612117565b50506006805460ff60b81b1916600160b81b17905550909250905061175d6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001661238e565b61178f7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031661238e565b600254600080808061179f612b30565b6007546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa15801561180c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906118309190614eb4565b9250838311611840576000611856565b600a61184c8585614e2e565b6118569190614ee3565b9350611877846118668585614dce565b6118709190614e2e565b8d876122bd565b9850818911156118f1578161188c8a86614dce565b6118969190614e2e565b91506118cb6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168361388c565b83600960008282546118dd9190614dce565b909155506118ed90508284614e2e565b6007555b6118f96128ac565b6008546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa158015611966573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061198a9190614eb4565b925083831161199a5760006119b0565b600a6119a68585614e2e565b6119b09190614ee3565b93506119c0846118668585614dce565b975081881115611a3a57816119d58986614dce565b6119df9190614e2e565b9150611a146001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168361388c565b83600a6000828254611a269190614dce565b90915550611a3690508284614e2e565b6008555b6000611a4588613906565b505050509050611a69611a62826001600160801b03168f896122bd565b8990612740565b92975090955093509150611a7d858b614dce565b9950611a89848a614dce565b9850611a96600a84614ee3565b9450611aa3600a83614ee3565b9350611ab9611ab28685614e2e565b8e886122bd565b611ac3908b614dce565b9950611ad2611ab28584614e2e565b611adc908a614dce565b98508460096000828254611af09190614dce565b9250508190555083600a6000828254611b099190614dce565b9250508190555050856040015160020b866020015160020b14611ba3576000611b3187613906565b505050509050611b55611b4e826001600160801b03168f896122bd565b8890612740565b92975090955093509150611b6a838e886122bd565b611b749086614dce565b611b7e908b614dce565b9950611b8b828e886122bd565b611b959085614dce565b611b9f908a614dce565b9850505b8a891015611bf35760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f770000000000000000000000604482015260640161128f565b89881015611c435760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f770000000000000000000000604482015260640161128f565b611c776001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338b6139ee565b611cab6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338a6139ee565b611cb5338d613a1e565b604080518d8152602081018b905290810189905233907f02f25270a4d87bea75db541cdfe559334a275b4a233520ed6c0a2429667cca949060600160405180910390a250506006805460ff60b81b191690555094989397509295505050505050565b33600090815260036020526040812080548391908390611d38908490614e2e565b90915550506001600160a01b038316600081815260036020526040908190208054850190555133907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90610a189086815260200190565b6006546000906115d290600160601b900465ffffffffffff1661236a565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001614611de257600080fd5b8315611e1c57611e1c6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633866139ee565b8215611e5657611e566001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633856139ee565b50505050565b42841015611eac5760405162461bcd60e51b815260206004820152601760248201527f5045524d49545f444541444c494e455f45585049524544000000000000000000604482015260640161128f565b6000611eb66115a1565b6001600160a01b0389811660008181526005602090815260409182902080546001810190915582517f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c98184015280840194909452938c166060840152608083018b905260a083019390935260c08083018a90528151808403909101815260e08301909152805192019190912061190160f01b6101008301526101028201929092526101228101919091526101420160408051601f198184030181528282528051602091820120600080855291840180845281905260ff88169284019290925260608301869052608083018590529092509060019060a0016020604051602081039080840390855afa158015611fcf573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116158015906120055750886001600160a01b0316816001600160a01b0316145b6120515760405162461bcd60e51b815260206004820152600e60248201527f494e56414c49445f5349474e4552000000000000000000000000000000000000604482015260640161128f565b6001600160a01b0390811660009081526004602090815260408083208b8516808552908352928190208a905551898152919350918a16917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a350505050505050565b6000806120c98385614ef7565b905060008160020b13156120e257830382019050610a24565b90920392915050565b6000806120f88385614ef7565b905060008160020b1261210e5783039050610a24565b90920303919050565b604080516060810182526000808252602082018190529181019190915260408051606081018252600080825260208201819052918101919091526040805161010081018252600654600281810b835263010000008204810b602084015266010000000000008204810b938301939093526901000000000000000000810490920b606082015265ffffffffffff600160601b830416608082015263ffffffff600160901b83041660a082015260ff600160b01b83048116151560c0830152600160b81b90920490911615801560e083015260009182918291906121f857600080fd5b60405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001826000015160020b8152602001826020015160020b81525060405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001836040015160020b8152602001836060015160020b81525082608001518360a001518460c0015195509550955095509550509091929394565b6000816122c957600080fd5b60008060001985870985870292508281108382030391505080600014156122f55750829004905061122f565b83811061230157600080fd5b60008486880960026001871981018816978890046003810283188082028403028082028403028082028403028082028403028082028403029081029092039091026000889003889004909101858311909403939093029303949094049190911702949350505050565b6000610a24620186a061238565ffffffffffff851642614e2e565b620151806122bd565b6040805160048152602481019091526020810180516001600160e01b0316630302f06b60e31b1790526123cb906001600160a01b03831690613a92565b5050565b60408051608081018252600080825260208201819052918101829052606081018290528190600080876040015160020b886020015160020b146124725761241588613906565b6001600160801b039485166060890181905291851696509093169350612440928b92508a9150613ab7565b602085015280845282908490612457908390614dce565b90525060208301805182919061246e908390614dce565b9052505b6007546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156124dc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125009190614eb4565b9050818111612510576000612526565b600a61251c8383614e2e565b6125269190614ee3565b9150856125335781612536565b60005b8161253f612b30565b6125499190614dce565b6125539190614e2e565b83518490612562908390614dce565b9052506008546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156125cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125f39190614eb4565b9050818111612603576000612619565b600a61260f8383614e2e565b6126199190614ee3565b9150856126265781612629565b60005b816126326128ac565b61263c9190614dce565b6126469190614e2e565b836020018181516126579190614dce565b905250604089015160208a0151600291820b910b146127275761267989613906565b6001600160801b0394851660408901819052918516965090931693506126a4928c92508a9150613ab7565b9095509350856126be576126b9600a83614ee3565b6126c1565b60005b83516126ce908490614dce565b6126d89190614e2e565b6126e29086614dce565b9450856126f9576126f4600a82614ee3565b6126fc565b60005b81846020015161270c9190614dce565b6127169190614e2e565b6127209085614dce565b9350612734565b8251602084015190955093505b50509450945094915050565b60008080806001600160801b038516156127ea5785516020870151604080890151905163a34123a760e01b8152600292830b6004820152910b60248201526001600160801b03871660448201526001600160a01b039091169063a34123a79060640160408051808303816000875af11580156127c0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906127e49190614f19565b90945092505b8551602087015160408089015190516309e3d67b60e31b8152306004820152600292830b6024820152910b60448201526001600160801b0360648201819052608482015260009182916001600160a01b0390911690634f1eb3d89060a40160408051808303816000875af1158015612866573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061288a9190614f54565b96999598506001600160801b039081168a900397509095168790039450505050565b600a546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a08231906024015b602060405180830381865afa158015612918573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061293c9190614eb4565b6115d29190614e2e565b6008546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156129b3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906129d79190614eb4565b90508181116129e75760006129ee565b600a828203045b9150818103841115612a005781810393505b612a356001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683860161388c565b600a805483019055038290036008555090565b600061122f612a5a8460200151613aea565b612a678560400151613aea565b84613e3d565b6000806001600160801b03831615612b2957835160208501516040808701519051633c8a7d8d60e01b8152306004820152600292830b6024820152910b60448201526001600160801b038516606482015260a06084820152600060a48201526001600160a01b0390911690633c8a7d8d9060c40160408051808303816000875af1158015612aff573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612b239190614f19565b90925090505b9250929050565b6009546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a08231906024016128fb565b6007546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015612bf0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612c149190614eb4565b9050818111612c24576000612c2b565b600a828203045b9150818103841115612c3d5781810393505b612c726001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683860161388c565b6009805483019055038290036007555090565b600061122f612c978460200151613aea565b612ca48560400151613aea565b84613e8e565b604080516060810182526000808252602082018190529181018290529080612cd28888612740565b935093505050600a60ff168281612ceb57612ceb614ecd565b60098054929091049091019055600a805491819004909101905550600082612d1557616c50612de4565b87516040808a015190516326fbd52f60e01b81526001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081166004830152928316602482015260029190910b6044820152612de4917f000000000000000000000000000000000000000000000000000000000000000016906326fbd52f906064016020604051808303816000875af1158015612dbb573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612ddf9190614eb4565b613ee5565b60020b60011d9050600080612dfa878785613f5f565b91509150600080612e10896101f46127106122bd565b612e18612b30565b039150612e2a886101f46127106122bd565b612e326128ac565b03905083821215612e515760009850612e4c828503612b83565b820193505b82811215612e6d5760009750612e68818403612946565b810192505b612e9d858d60400151037f00000000000000000000000000000000000000000000000000000000000000006120eb565b60020b60208c015260408c0151612ed69086017f00000000000000000000000000000000000000000000000000000000000000006120bc565b600290810b60408d015260208c01517f0000000000000000000000000000000000000000000000000000000000000000820b910b1215612f3a577f000000000000000000000000000000000000000000000000000000000000000060020b60208c01525b7f000000000000000000000000000000000000000000000000000000000000000060020b8b6040015160020b1315612f96577f000000000000000000000000000000000000000000000000000000000000000060020b60408c01525b8b51612fa990610d73908d908787613fd4565b9094509250881561301257612ff1612fc18584614e2e565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690613ffb565b612ffb8483614e2e565b6007600082825461300c9190614dce565b90915550505b8715613076576130556130258483614e2e565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690613ffb565b61305f8382614e2e565b600860008282546130709190614dce565b90915550505b7fe73e1a034909b10f2cbe101ce0618d683b1485c1c2da61474bdbebce08bcaf1a8b602001518c604001516040516130be929190600292830b8152910b602082015260400190565b60405180910390a150989a9950505050505050505050565b60006001600160a01b03861661313257604080516000808252602082015263ffffffff87168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a150806134f1565b6001600160a01b0386166000908152600b60205260408120549061317061315f63ffffffff881684614f87565b8863ffffffff16633b9aca006122bd565b90507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b0316141561323257600954808211806131bb575082155b156131c4578091505b6131ce8282614e2e565b905060006131ef6131e0601486614f87565b8863ffffffff166127106122bd565b90508082116131fe5781613200565b805b60095580821115613214576001955061322b565b61321f600482614ee3565b82101561322b57600095505b505061346d565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b031614156132c557600a548082118061327b575082155b15613284578091505b61328e8282614e2e565b905060006132a06131e0601486614f87565b90508082116132af57816132b1565b805b600a5580821115613214576001955061322b565b6040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a0823190602401602060405180830381865afa15801561330c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133309190614eb4565b90508082118061333e575082155b15613347578091505b60405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa1580156133ad573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906133d19190614fa6565b8015613462575060405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa15801561343e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906134629190614fa6565b61346b57600080fd5b505b6134816001600160a01b03891633836139ee565b61349d88613498612710848a63ffffffff166122bd565b61401a565b604080516001600160a01b038a1681526020810183905263ffffffff89168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a183925050505b95945050505050565b806040015160020b816020015160020b14156135135750565b600061351e82613906565b505050509050806001600160801b03166000146123cb5781516020830151604080850151905163a34123a760e01b8152600292830b6004820152910b6024820152600060448201526001600160a01b039091169063a34123a79060640160408051808303816000875af1158015613599573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611e569190614f19565b600080808815806135cd57508715155b806135d757508615155b6135e3576135e3614fc1565b886136585760006136026001600160a01b03861680600160601b6122bd565b905061361c86600160601b836001600160e01b03166122bd565b92508683101561363157859150819350613652565b86925061364c83826001600160e01b0316600160601b6122bd565b91508293505b506136f7565b8761367157508361366a818a896122bd565b92506136f7565b866136845785915061366a828a8a6122bd565b600087891061369f5761369887898b6122bd565b86106136ad565b866136ab878b8b6122bd565b105b905080156136d7578591506136c3828a8a6122bd565b92506136d0828b8a6122bd565b93506136f5565b8692506136e583898b6122bd565b91506136f2838b8b6122bd565b93505b505b96509650969350505050565b6040516001600160a01b0380851660248301528316604482015260648101829052611e569085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff0000000000000000000000000000000000000000000000000000000090931692909217909152614104565b80600260008282546137989190614dce565b90915550506001600160a01b0382166000818152600360209081526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91015b60405180910390a35050565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60006040516138249190614fd7565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b6040516024810182905261390190632e1a7d4d60e01b906044015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091526001600160a01b03841690613a92565b505050565b600080600080600085600001516001600160a01b031663514ea4bf30886020015189604001516040516020016139679392919060609390931b6bffffffffffffffffffffffff1916835260e891821b6014840152901b6017820152601a0190565b604051602081830303815290604052805190602001206040518263ffffffff1660e01b815260040161399b91815260200190565b60a060405180830381865afa1580156139b8573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906139dc9190615073565b939a9299509097509550909350915050565b6040516001600160a01b03831660248201526044810182905261390190849063a9059cbb60e01b90606401613737565b6001600160a01b03821660009081526003602052604081208054839290613a46908490614e2e565b90915550506002805482900390556040518181526000906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020016137e6565b606061122f838360405180606001604052806027815260200161526b602791396141e9565b600080613ade84613acb8760200151613aea565b613ad88860400151613aea565b866142d4565b91509150935093915050565b60008060008360020b12613b01578260020b613b0e565b8260020b613b0e906150ca565b9050613b1d620d89e7196150e7565b62ffffff16811115613b555760405162461bcd60e51b81526020600482015260016024820152601560fa1b604482015260640161128f565b600060018216613b7657700100000000000000000000000000000000613b88565b6ffffcb933bd6fad37aa2d162d1a5940015b70ffffffffffffffffffffffffffffffffff1690506002821615613bbc576ffff97272373d413259a46990580e213a0260801c5b6004821615613bdb576ffff2e50f5f656932ef12357cf3c7fdcc0260801c5b6008821615613bfa576fffe5caca7e10e4e61c3624eaa0941cd00260801c5b6010821615613c19576fffcb9843d60f6159c9db58835c9266440260801c5b6020821615613c38576fff973b41fa98c081472e6896dfb254c00260801c5b6040821615613c57576fff2ea16466c96a3843ec78b326b528610260801c5b6080821615613c76576ffe5dee046a99a2a811c461f1969c30530260801c5b610100821615613c96576ffcbe86c7900a88aedcffc83b479aa3a40260801c5b610200821615613cb6576ff987a7253ac413176f2b074cf7815e540260801c5b610400821615613cd6576ff3392b0822b70005940c7a398e4b70f30260801c5b610800821615613cf6576fe7159475a2c29b7443b29c7fa6e889d90260801c5b611000821615613d16576fd097f3bdfd2022b8845ad8f792aa58250260801c5b612000821615613d36576fa9f746462d870fdf8a65dc1f90e061e50260801c5b614000821615613d56576f70d869a156d2a1b890bb3df62baf32f70260801c5b618000821615613d76576f31be135f97d08fd981231505542fcfa60260801c5b62010000821615613d97576f09aa508b5b7a84e1c677de54f3e99bc90260801c5b62020000821615613db7576e5d6af8dedb81196699c329225ee6040260801c5b62040000821615613dd6576d2216e584f5fa1ea926041bedfe980260801c5b62080000821615613df3576b048a170391f7dc42444e8fa20260801c5b60008460020b1315613e14578060001981613e1057613e10614ecd565b0490505b640100000000810615613e28576001613e2b565b60005b60ff16602082901c0192505050919050565b6000826001600160a01b0316846001600160a01b03161115613e5d579192915b613e86613e8183600160601b613e73888861510a565b6001600160a01b03166122bd565b6143b6565b949350505050565b6000826001600160a01b0316846001600160a01b03161115613eae579192915b6000613ed1856001600160a01b0316856001600160a01b0316600160601b6122bd565b90506134f1613e818483613e73898961510a565b6000662358b99a116be08211613efe5750610192919050565b67053448a4815102008210613f165750616c50919050565b613f21600283614f87565b91506000670de0b6b3a7640000839003730de0b6b3a764000000000000000000000000000081613f5357613f53614ecd565b04905061122f816143d1565b60008080613f74613f6f856150e7565b613aea565b613f8b906001600160a01b0316600160601b614e2e565b9050613faa86826bffffffffffffffffffffffff16600160601b6122bd565b9250613fc985826bffffffffffffffffffffffff16600160601b6122bd565b915050935093915050565b60006134f184613fe78760200151613aea565b613ff48860400151613aea565b8686614718565b604051602481018290526139019063b6b55f2560e01b906044016138a7565b6001600160a01b0382166000908152600c60209081526040808320600d835281842054600b90935292205460ff90911690600a8104808203851015614063578082039450614073565b8082018511156140735780820194505b600e85049450838360ff16600e811061408e5761408e615132565b01546001600160a01b0387166000908152600b60205260409020838701919091039055848460ff8516600e81106140c7576140c7615132565b0155600e60ff60018501166001600160a01b03979097166000908152600d60205260409020805460ff19169190970660ff16179095555050505050565b6000614159826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166147d09092919063ffffffff16565b80519091501561390157808060200190518101906141779190614fa6565b6139015760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f74207375636365656400000000000000000000000000000000000000000000606482015260840161128f565b6060833b61425f5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f60448201527f6e74726163740000000000000000000000000000000000000000000000000000606482015260840161128f565b600080856001600160a01b03168560405161427a9190615148565b600060405180830381855af49150503d80600081146142b5576040519150601f19603f3d011682016040523d82523d6000602084013e6142ba565b606091505b50915091506142ca8282866147df565b9695505050505050565b600080836001600160a01b0316856001600160a01b031611156142f5579293925b846001600160a01b0316866001600160a01b03161161432957614319858585614818565b6001600160e01b031691506143ad565b836001600160a01b0316866001600160a01b031610156143855761434e868585614818565b6001600160e01b031691506143648587856148a6565b77ffffffffffffffffffffffffffffffffffffffffffffffff1690506143ad565b6143908585856148a6565b77ffffffffffffffffffffffffffffffffffffffffffffffff1690505b94509492505050565b806001600160801b03811681146143cc57600080fd5b919050565b60006401000276a36001600160a01b0383161080159061440d575073fffd8963efd1fc6a506488495d951d5263988d266001600160a01b038316105b61443d5760405162461bcd60e51b81526020600482015260016024820152602960f91b604482015260640161128f565b77ffffffffffffffffffffffffffffffffffffffff00000000602083901b166001600160801b03811160071b81811c67ffffffffffffffff811160061b90811c63ffffffff811160051b90811c61ffff811160041b90811c60ff8111600390811b91821c600f811160021b90811c918211600190811b92831c979088119617909417909217179091171717608081106144e5576144db607f82614e2e565b83901c91506144f6565b6144f081607f614e2e565b83901b91505b60006040614505608084615164565b901b9050828302607f1c92508260801c80603f1b8217915083811c935050828302607f1c92508260801c80603e1b8217915083811c935050828302607f1c92508260801c80603d1b8217915083811c935050828302607f1c92508260801c80603c1b8217915083811c935050828302607f1c92508260801c80603b1b8217915083811c935050828302607f1c92508260801c80603a1b8217915083811c935050828302607f1c92508260801c8060391b8217915083811c935050828302607f1c92508260801c8060381b8217915083811c935050828302607f1c92508260801c8060371b8217915083811c935050828302607f1c92508260801c8060361b8217915083811c935050828302607f1c92508260801c8060351b8217915083811c935050828302607f1c92508260801c8060341b8217915083811c935050828302607f1c92508260801c8060331b8217915083811c935050828302607f1c92508260801c8060321b8217915050600081693627a301d71055774c8561468891906151a3565b9050600060806146a86f028f6481ab7f045a5af012a19d003aaa84615164565b901d9050600060806146ca846fdb2df09e81959a81455e260799a0632f61522a565b901d90508060020b8260020b1461470957886001600160a01b03166146ee82613aea565b6001600160a01b03161115614703578161470b565b8061470b565b815b9998505050505050505050565b6000836001600160a01b0316856001600160a01b03161115614738579293925b846001600160a01b0316866001600160a01b0316116147635761475c858585613e8e565b90506134f1565b836001600160a01b0316866001600160a01b031610156147c557600061478a878686613e8e565b90506000614799878986613e3d565b9050806001600160801b0316826001600160801b0316106147ba57806147bc565b815b925050506134f1565b6142ca858584613e3d565b6060613e8684846000856148f0565b606083156147ee57508161122f565b8251156147fe5782518084602001fd5b8160405162461bcd60e51b815260040161128f9190614a5b565b6000826001600160a01b0316846001600160a01b03161115614838579192915b6001600160a01b03841661488a7bffffffffffffffffffffffffffffffff000000000000000000000000606085901b16614872878761510a565b6001600160a01b0316866001600160a01b03166122bd565b6148949190614ee3565b67ffffffffffffffff16949350505050565b6000826001600160a01b0316846001600160a01b031611156148c6579192915b613e866001600160801b0383166148dd868661510a565b6001600160a01b0316600160601b6122bd565b6060824710156149685760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c0000000000000000000000000000000000000000000000000000606482015260840161128f565b843b6149b65760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161128f565b600080866001600160a01b031685876040516149d29190615148565b60006040518083038185875af1925050503d8060008114614a0f576040519150601f19603f3d011682016040523d82523d6000602084013e614a14565b606091505b5091509150614a248282866147df565b979650505050505050565b60005b83811015614a4a578181015183820152602001614a32565b83811115611e565750506000910152565b6020815260008251806020840152614a7a816040850160208701614a2f565b601f01601f19169190910160400192915050565b6001600160a01b0381168114614aa357600080fd5b50565b60008060408385031215614ab957600080fd5b8235614ac481614a8e565b946020939093013593505050565b600060208284031215614ae457600080fd5b813561122f81614a8e565b600080600060608486031215614b0457600080fd5b8335614b0f81614a8e565b92506020840135614b1f81614a8e565b929592945050506040919091013590565b60008060008060808587031215614b4657600080fd5b5050823594602084013594506040840135936060013592509050565b600080600060608486031215614b7757600080fd5b505081359360208301359350604090920135919050565b60008060008060608587031215614ba457600080fd5b8435935060208501359250604085013567ffffffffffffffff80821115614bca57600080fd5b818701915087601f830112614bde57600080fd5b813581811115614bed57600080fd5b886020828501011115614bff57600080fd5b95989497505060200194505050565b60ff81168114614aa357600080fd5b600080600080600080600060e0888a031215614c3857600080fd5b8735614c4381614a8e565b96506020880135614c5381614a8e565b955060408801359450606088013593506080880135614c7181614c0e565b9699959850939692959460a0840135945060c09093013592915050565b60008060408385031215614ca157600080fd5b8235614cac81614a8e565b91506020830135614cbc81614a8e565b809150509250929050565b600181811c90821680614cdb57607f821691505b60208210811415614cfc57634e487b7160e01b600052602260045260246000fd5b50919050565b805161ffff811681146143cc57600080fd5b805180151581146143cc57600080fd5b600080600080600080600060e0888a031215614d3f57600080fd5b8751614d4a81614a8e565b8097505060208801518060020b8114614d6257600080fd5b9550614d7060408901614d02565b9450614d7e60608901614d02565b9350614d8c60808901614d02565b925060a0880151614d9c81614c0e565b9150614daa60c08901614d14565b905092959891949750929550565b634e487b7160e01b600052601160045260246000fd5b60008219821115614de157614de1614db8565b500190565b60008160020b8360020b6000811281627fffff1901831281151615614e0d57614e0d614db8565b81627fffff018313811615614e2457614e24614db8565b5090039392505050565b600082821015614e4057614e40614db8565b500390565b60008160020b8360020b6000821282627fffff03821381151615614e6b57614e6b614db8565b82627fffff19038212811615614e8357614e83614db8565b50019392505050565b600063ffffffff808316818516808303821115614eab57614eab614db8565b01949350505050565b600060208284031215614ec657600080fd5b5051919050565b634e487b7160e01b600052601260045260246000fd5b600082614ef257614ef2614ecd565b500490565b60008260020b80614f0a57614f0a614ecd565b808360020b0791505092915050565b60008060408385031215614f2c57600080fd5b505080516020909101519092909150565b80516001600160801b03811681146143cc57600080fd5b60008060408385031215614f6757600080fd5b614f7083614f3d565b9150614f7e60208401614f3d565b90509250929050565b6000816000190483118215151615614fa157614fa1614db8565b500290565b600060208284031215614fb857600080fd5b61122f82614d14565b634e487b7160e01b600052600160045260246000fd5b600080835481600182811c915080831680614ff357607f831692505b602080841082141561501357634e487b7160e01b86526022600452602486fd5b818015615027576001811461503857615065565b60ff19861689528489019650615065565b60008a81526020902060005b8681101561505d5781548b820152908501908301615044565b505084890196505b509498975050505050505050565b600080600080600060a0868803121561508b57600080fd5b61509486614f3d565b945060208601519350604086015192506150b060608701614f3d565b91506150be60808701614f3d565b90509295509295909350565b6000600160ff1b8214156150e0576150e0614db8565b5060000390565b60008160020b627fffff1981141561510157615101614db8565b60000392915050565b60006001600160a01b038381169083168181101561512a5761512a614db8565b039392505050565b634e487b7160e01b600052603260045260246000fd5b6000825161515a818460208701614a2f565b9190910192915050565b60008083128015600160ff1b85018412161561518257615182614db8565b836001600160ff1b0301831381161561519d5761519d614db8565b50500390565b60006001600160ff1b036000841360008413858304851182821616156151cb576151cb614db8565b600160ff1b60008712828116878305891216156151ea576151ea614db8565b6000871292508782058712848416161561520657615206614db8565b8785058712818416161561521c5761521c614db8565b505050929093029392505050565b6000808212826001600160ff1b030384138115161561524b5761524b614db8565b600160ff1b839003841281161561526457615264614db8565b5050019056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a2646970667358221220de83f84391daee039bdd904e17c955d66767f1bf5bde0f6a613de7c6828338d364736f6c634300080a0033";
const UINT256MAX = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

const ADDRESS_UNI_POOL = "0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640";
const ADDRESS_CTOKEN0 = "0x39AA39c021dfbaE8faC545936693aC917d5E7563";
const ADDRESS_CTOKEN1 = "0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5";
const WHALE = "0x4F868C1aa37fCf307ab38D215382e88FCA6275E2";

function prettyPrintRebalance(tx) {
  console.log("⚖️ The vault was rebalanced!");
  for (const log of tx.logs) {
    console.log(`\t${log.event}`);

    if (log.event === "Recenter") {
      const lower = log.args.lower.toNumber();
      const upper = log.args.upper.toNumber();
      const middle = Math.round((lower + upper) / 2);

      console.log(`\t   || ${lower} |======> ${middle} <======| ${upper} ||`);
    } else if (log.event === "Reward") {
      const token = log.args.token;
      const amount = log.args.amount.toNumber();
      const urgency = log.args.urgency.toNumber();

      console.log(`\t   urgency=${urgency / 1e5} ---> ${amount / 1e9} of ${token.slice(0, 6)}`);
    } else if (log.event === "Rebalance") {
      const ratio = log.args.ratio.toString(0);
      const shares = log.args.shares.toString(0);
      const inventory0 = log.args.inventory0.toString(0);
      const inventory1 = log.args.inventory1.toString(0);

      console.log(`\t   ratio=${ratio}  (${inventory0} / ${inventory1})`);
      console.log(`\t   ${shares} outstanding shares`);
    } else if (log.event === "Transfer") {
      let from = log.args.from;
      let to = log.args.to;
      const amount = log.args.amount.toString(0);

      if (from === ADDRESS_UNI_POOL) from = "Uniswap";
      else if (from === ADDRESS_CTOKEN0) from = "silo0";
      else if (from === ADDRESS_CTOKEN1) from = "silo1";
      if (to === ADDRESS_UNI_POOL) to = "Uniswap";
      else if (to === ADDRESS_CTOKEN0) to = "silo0";
      else if (to === ADDRESS_CTOKEN1) to = "silo1";

      console.log(`\t   (${log.address.slice(0, 7)})`);
      console.log(`\t   ${amount} from ${from.slice(0, 7)} to ${to.slice(0, 7)}`);
    }
  }
}

describe("USDC-WETH 0.05% | cUSDC | cETH @hardhat", () => {

  let accounts;
  let multisig;

  let aloeBlend;
  let factory;
  let oracle;
  let silo0;
  let silo1;

  let token0;
  let token1;

  before(async () => {
    await web3.eth.hardhat.reset({
      forking: {
        jsonRpcUrl: `https://eth-mainnet.alchemyapi.io/v2/${process.env.PROVIDER_ALCHEMY_KEY}`,
        blockNumber: 12802299,
      },
      accounts: [
        {
          privateKey: "0101010101010101010101010101010101010101010101010101010101010101",
          balance: "2000000000000000000",
        },
        {
          privateKey: process.env.DEPLOYER,
          balance: "2000000000000000000",
        },
      ],
    });
  });

  it("should deploy", async () => {
    accounts = await web3.eth.getAccounts();
    multisig = accounts[0];

    const deployer = web3.eth.accounts.privateKeyToAccount(process.env.DEPLOYER);

    oracle = await VolatilityOracle.new();
    factory = await Factory.new(oracle.address, BYTECODE);
    silo0 = await CompoundCTokenSilo.new(ADDRESS_CTOKEN0, {
      from: deployer.address,
    });
    silo1 = await CompoundCEtherSilo.new(ADDRESS_CTOKEN1, {
      from: deployer.address,
    });

    await factory.createVault(ADDRESS_UNI_POOL, silo0.address, silo1.address, {
      from: deployer.address,
    });
    const vaultAddress = await factory.getVault(ADDRESS_UNI_POOL, silo0.address, silo1.address);
    aloeBlend = await AloeBlend.at(vaultAddress);
    token0 = await ERC20.at(await aloeBlend.TOKEN0());
    token1 = await ERC20.at(await aloeBlend.TOKEN1());
  });

  it("should get inventory (zero)", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("0");
    expect(res.inventory1.toString(10)).to.equal("0");
  });

  it("should impersonate whale", async () => {
    await web3.eth.hardhat.impersonate(WHALE);

    const balance0 = await token0.balanceOf(WHALE);
    const balance1 = await token1.balanceOf(WHALE);

    expect(balance0.gt(2000e6)).to.be.true;
    expect(balance1.gt(1e18)).to.be.true;
  });

  it("should fail to deposit before approving tokens", async () => {
    const tx = aloeBlend.deposit("100000000", "100000000000000000", 0, 0, {
      from: WHALE,
    });
    await expect(tx).to.eventually.be.rejectedWith(
      Error,
      "VM Exception while processing transaction: reverted with reason string 'ERC20: transfer amount exceeds allowance'"
    );
  });

  it("should approve tokens for vault management", async () => {
    const tx0 = await token0.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    const tx1 = await token1.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    expect(tx0.receipt.status).to.be.true;
    expect(tx1.receipt.status).to.be.true;
  });

  it("should deposit", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "50000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("100000000");
    expect(deposit.args.amount0.toString(10)).to.equal("100000000");
    expect(deposit.args.amount1.toString(10)).to.equal("47451794160948057");
  });

  it("should deposit proportionally", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "40000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("84296075");
    expect(deposit.args.amount0.toString(10)).to.equal("84296075");
    expect(deposit.args.amount1.toString(10)).to.equal("40000000000000000");
  });

  it("should rebalance", async () => {
    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589708047402); // 5% of inventory1 (contract float)

    const urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should go to next block", async () => {
    await web3.eth.hardhat.mine();
  });

  it("should get inventory before rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794076657509");
  });

  it("should rebalance again", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(1);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4380941078269389); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory after rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296074");
    expect(res.inventory1.toString(10)).to.equal("87451794079037807");
  });

  it("should rebalance a third time", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589705422976); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory once more", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794088820670");
  });

  it("should withdraw", async () => {
    const shares = (await aloeBlend.balanceOf(WHALE)).toNumber();
    expect(shares).to.equal(184296075);

    const tx0 = await aloeBlend.withdraw("184296075", 0, 0, { from: WHALE });
    const withdraw = tx0.logs[tx0.logs.length - 1];
    expect(withdraw.event).to.equal("Withdraw");
    expect(withdraw.args.shares.toString(10)).to.equal("184296075");
    expect(withdraw.args.amount0.toString(10)).to.equal("184296074");
    expect(withdraw.args.amount1.toString(10)).to.equal("87451794118248630");

    console.log((await token0.balanceOf(aloeBlend.address)).toString(10));
    console.log((await token1.balanceOf(aloeBlend.address)).toString(10));
  });
});
